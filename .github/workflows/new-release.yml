~name: New Release

on:
  schedule:
    - cron: "0 0 * * 4"  # Weekly on Thursday at midnight UTC
  workflow_dispatch:  # Allow manual triggering
    inputs:
      debug_mode:
        description: 'Enable debug logging'
        required: false
        default: 'true'
        type: boolean
      worker_override:
        description: 'Override worker counts (format: teams,players e.g., "2,4")'
        required: false
        default: ''
        type: string
      delay_override:
        description: 'Override request delay in seconds'
        required: false
        default: ''
        type: string

jobs:
  Release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3 hour timeout for long-running downloads
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          python-version: 3.14t
          
      - name: Verify Python version and GIL status
        run: |
          uv run python --version
          uv run python -c "import sys; print(f'GIL Enabled: {sys._is_gil_enabled()}')"
          echo "Expected: GIL Enabled: False (free-threading active)"
          
      - name: Install system dependencies
        run: |
          sudo apt-get install -y rar imagemagick libmagickwand-dev
          
      - name: Install Python dependencies
        run: |
          uv sync
          
      - name: Run optimized script
        run: |
          echo "Starting eFootball miniface download..."
          echo "Trigger: ${{ github.event_name }}"
          
          # Verify GIL is disabled
          uv run python -c "import sys; assert not sys._is_gil_enabled(), 'GIL should be disabled!'"
          echo "âœ“ Free-threading confirmed active"
          
          # Build command with appropriate options
          SCRIPT_CMD="uv run script.py"
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger detected"
            
            # Check debug mode input (defaults to true for manual runs)
            if [ "${{ inputs.debug_mode }}" = "true" ]; then
              echo "Debug logging enabled"
              SCRIPT_CMD="$SCRIPT_CMD --debug"
            else
              echo "Debug logging disabled by user input"
              SCRIPT_CMD="$SCRIPT_CMD --quiet"
            fi
            
            # Apply worker overrides if provided
            if [ -n "${{ inputs.worker_override }}" ]; then
              IFS=',' read -r teams players <<< "${{ inputs.worker_override }}"
              if [[ "$teams" =~ ^[0-9]+$ ]] && [[ "$players" =~ ^[0-9]+$ ]]; then
                echo "Overriding workers: $teams teams, $players players"
                SCRIPT_CMD="$SCRIPT_CMD --workers-teams $teams --workers-players $players"
              else
                echo "Invalid worker override format, using defaults"
              fi
            fi
            
            # Apply delay override if provided
            if [ -n "${{ inputs.delay_override }}" ]; then
              if [[ "${{ inputs.delay_override }}" =~ ^[0-9]*\.?[0-9]+$ ]]; then
                echo "Overriding request delay: ${{ inputs.delay_override }}s"
                SCRIPT_CMD="$SCRIPT_CMD --delay ${{ inputs.delay_override }}"
              else
                echo "Invalid delay override format, using default"
              fi
            fi
            
          else
            echo "Scheduled trigger detected - running in optimized quiet mode"
            SCRIPT_CMD="$SCRIPT_CMD --quiet"
          fi
          
          echo "Executing: $SCRIPT_CMD"
          eval $SCRIPT_CMD
          echo "Download completed successfully!"
          
      - name: Verify output
        run: |
          echo "Verifying download results..."
          
          if [ ! -d "MinifaceServer" ]; then
            echo "âŒ Error: MinifaceServer directory not found"
            exit 1
          fi
          
          total_files=$(find MinifaceServer -name "*.dds" | wc -l)
          total_players=$(find MinifaceServer -maxdepth 1 -type d -name "[0-9]*" | wc -l)
          
          echo "ðŸ“Š Download Statistics:"
          echo "  - Total miniface files: $total_files"
          echo "  - Total players: $total_players"
          
          if [ $total_files -eq 0 ]; then
            echo "âŒ Warning: No miniface files were generated"
            exit 1
          fi
          
          # Show detailed info for manual triggers
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.debug_mode }}" = "true" ]; then
            echo ""
            echo "ðŸ” Debug Information:"
            echo "  - Directory structure:"
            du -sh MinifaceServer/* | head -10
            echo "  - Sample player directories:"
            ls MinifaceServer/ | grep -E '^[0-9]+$' | head -5
            echo "  - Recent files:"
            find MinifaceServer -name "*.dds" -newer MinifaceServer -print | head -5
          fi
          
          echo "âœ… Verification completed successfully"
          echo "TOTAL_PLAYERS=$(total_players)" >> $GITHUB_ENV
          
      - name: Commit skipped_players.txt
        run: |
          set -e
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          SKIPFILE="MinifaceServer/content/miniface-server/skipped_players.txt"
          if [ -f "$SKIPFILE" ]; then
            git add "$SKIPFILE"
            if ! git diff --cached --quiet; then
              git commit -m "chore: update skipped_players.txt from release run"
              git push origin HEAD:${GITHUB_REF##*/}
              echo "Pushed updated skip list"
            else
              echo "No changes in skip list"
            fi
          else
            echo "Skip file not found: $SKIPFILE"
          fi

      - name: Create optimized archive
        run: |
          echo "Creating archive..."
          # Use better compression and exclude unnecessary files
          rar a -r -m5 -ep1 "MiniFaceServer-$(date +'%m-%d-%Y').rar" MinifaceServer \
            -x*.tmp -x*.log -x__pycache__ -x*.pyc
          
          # Get archive size for logging
          archive_size=$(du -h "MiniFaceServer-$(date +'%m-%d-%Y').rar" | cut -f1)
          echo "Archive created successfully: $archive_size"
          
      - name: Set release variables
        run: |
          echo "RELEASE_NAME=MiniFaceServer-$(date +'%m-%d-%Y')" >> $GITHUB_ENV
          echo "NEXT_VER_CODE=$(date +'%m%d%Y')" >> $GITHUB_ENV
          echo "RELEASE_DATE=$(date +'%B %d, %Y')" >> $GITHUB_ENV
          
          # Set trigger type for release notes
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "TRIGGER_TYPE=Manual" >> $GITHUB_ENV
            echo "TRIGGER_DETAILS=Manually triggered release" >> $GITHUB_ENV
          else
            echo "TRIGGER_TYPE=Scheduled" >> $GITHUB_ENV
            echo "TRIGGER_DETAILS=Automatically triggered on schedule" >> $GITHUB_ENV
          fi
          
      - name: Check if release exists and add full release or create new release
        run: |
          # Check if release with this tag already exists
          if gh release view ${{ env.NEXT_VER_CODE }} >/dev/null 2>&1; then
            echo "Release ${{ env.NEXT_VER_CODE }} exists, adding full release archive..."
            gh release upload ${{ env.NEXT_VER_CODE }} "MiniFaceServer-$(date +'%m-%d-%Y').rar" --clobber
            echo "âœ… Full release archive added to existing release"
          else
            echo "Release ${{ env.NEXT_VER_CODE }} does not exist, creating new release..."
            gh release create ${{ env.NEXT_VER_CODE }} "MiniFaceServer-$(date +'%m-%d-%Y').rar" \
              --title "${{ env.RELEASE_NAME }}" \
              --notes "# eFootball MinifacesServer - ${{ env.RELEASE_DATE }}
            
            **Release Type:** ${{ env.TRIGGER_TYPE }}
            **Generated:** ${{ env.TRIGGER_DETAILS }}
            Automated release containing the latest minifaces for eFootball.
            
            ## Installation
            1. Copy \"content\" and \"modules\" folder to your sider folder
            2. Add the following line in your sider.ini:
            \`\`\`
            lua.module = \"MiniFaceServer.lua\"
            \`\`\`
            
            ## Technical Details
            - Generated using optimized multithreaded downloader
            - Source: PESMaster database
            - Release Date: ${{ env.RELEASE_DATE }}
            - Total Players: ${{ env.TOTAL_PLAYERS }}
            
            For more info: https://evoweb.uk/threads/efootball-featured-players-miniface-server-automated-aio.91794/
            ---
            *This release was generated by GitHub Actions using the optimized script*"
            echo "âœ… New release created with full release archive"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
