name: New Update

on:
  schedule:
    - cron: "0 6 * * 4" # Weekly on Thursday at 6 AM UTC (6 hours after new-release)
  workflow_dispatch: # Allow manual triggering
    inputs:
      debug_mode:
        description: "Enable debug logging"
        required: false
        default: "true"
        type: boolean
      worker_override:
        description: 'Override worker count (e.g., "8")'
        required: false
        default: ""
        type: string
      delay_override:
        description: "Override request delay in seconds"
        required: false
        default: ""
        type: string

jobs:
  Update:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    timeout-minutes: 60 # 1 hour timeout for featured players only

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          python-version: 3.14t

      - name: Setup Python with uv
        run: |
          uv python install 3.14t
          uv python pin 3.14t

      - name: Verify Python version and GIL status
        run: |
          uv run python --version
          uv run python -c "import sys; print(f'GIL Enabled: {sys._is_gil_enabled()}')"
          echo "Expected: GIL Enabled: False (free-threading active)"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y rar imagemagick libmagickwand-dev

      - name: Install Python dependencies
        run: |
          uv sync

      - name: Run optimized featured players script
        run: |
          echo "Starting featured players download with Python 3.14t free-threading..."
          echo "Trigger: ${{ github.event_name }}"

          # Verify GIL is disabled
          uv run python -c "import sys; assert not sys._is_gil_enabled(), 'GIL should be disabled!'"
          echo "âœ“ Free-threading confirmed active"

          # Build command with appropriate options
          SCRIPT_CMD="uv run get_update_only.py"

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger detected"
            
            # Check debug mode input (defaults to true for manual runs)
            if [ "${{ inputs.debug_mode }}" = "true" ]; then
              echo "Debug logging enabled"
              SCRIPT_CMD="$SCRIPT_CMD --debug"
            else
              echo "Debug logging disabled by user input"
              SCRIPT_CMD="$SCRIPT_CMD --quiet"
            fi
            
            # Apply worker override if provided
            if [ -n "${{ inputs.worker_override }}" ]; then
              if [[ "${{ inputs.worker_override }}" =~ ^[0-9]+$ ]]; then
                echo "Overriding workers: ${{ inputs.worker_override }}"
                SCRIPT_CMD="$SCRIPT_CMD --workers ${{ inputs.worker_override }}"
              else
                echo "Invalid worker override format, using defaults"
              fi
            fi
            
            # Apply delay override if provided
            if [ -n "${{ inputs.delay_override }}" ]; then
              if [[ "${{ inputs.delay_override }}" =~ ^[0-9]*\.?[0-9]+$ ]]; then
                echo "Overriding request delay: ${{ inputs.delay_override }}s"
                SCRIPT_CMD="$SCRIPT_CMD --delay ${{ inputs.delay_override }}"
              else
                echo "Invalid delay override format, using default"
              fi
            fi
            
          else
            echo "Scheduled trigger detected - running in optimized quiet mode"
            SCRIPT_CMD="$SCRIPT_CMD --quiet"
          fi

          echo "Executing: $SCRIPT_CMD"
          eval $SCRIPT_CMD
          echo "Featured players download completed successfully!"

      - name: Verify output
        run: |
          echo "Verifying featured players download results..."

          if [ ! -d "MinifaceServer" ]; then
            echo "âŒ Error: MinifaceServer directory not found"
            exit 1
          fi

          total_files=$(find MinifaceServer -name "*.dds" | wc -l)
          total_players=$(find MinifaceServer -maxdepth 1 -type d -name "[0-9]*" | wc -l)

          echo "ðŸ“Š Featured Players Statistics:"
          echo "  - Total miniface files: $total_files"
          echo "  - Total featured players: $total_players"

          if [ $total_files -eq 0 ]; then
            echo "âŒ Warning: No featured player miniface files were generated"
            exit 1
          fi

          # Show detailed info for manual triggers
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.debug_mode }}" = "true" ]; then
            echo ""
            echo "ðŸ” Debug Information:"
            echo "  - Directory structure:"
            du -sh MinifaceServer/* | head -10
            echo "  - Sample player directories:"
            ls MinifaceServer/ | grep -E '^[0-9]+$' | head -5
            echo "  - Recent files:"
            find MinifaceServer -name "*.dds" -newer MinifaceServer -print | head -5
          fi

          echo "âœ… Featured players verification completed successfully"
          echo "TOTAL_FEATURED_PLAYERS=$total_players" >> $GITHUB_ENV

          # Verify MinifaceServer-Background
          echo ""
          echo "Verifying background version..."

          if [ ! -d "MinifaceServer-Background" ]; then
            echo "âŒ Error: MinifaceServer-Background directory not found"
            exit 1
          fi

          bg_files=$(find MinifaceServer-Background -name "*.dds" | wc -l)
          bg_players=$(find MinifaceServer-Background/content/miniface-server -maxdepth 1 -type d -name "[0-9]*" | wc -l)

          echo "ðŸ“Š Background Version Statistics:"
          echo "  - Total miniface files: $bg_files"
          echo "  - Total featured players: $bg_players"

          if [ $bg_files -eq 0 ]; then
            echo "âŒ Warning: No background miniface files were generated"
            exit 1
          fi

          # Compare counts
          if [ $total_files -ne $bg_files ]; then
            echo "âš ï¸  Warning: File count mismatch (Standard: $total_files, Background: $bg_files)"
          else
            echo "âœ… Both versions have matching file counts"
          fi

      - name: Sync skipped_players.txt to background version
        run: |
          SKIPFILE="MinifaceServer/content/miniface-server/skipped_players.txt"
          BG_SKIPFILE="MinifaceServer-Background/content/miniface-server/skipped_players.txt"

          if [ -f "$SKIPFILE" ]; then
            cp "$SKIPFILE" "$BG_SKIPFILE"
            echo "âœ… Synced skipped_players.txt to background version"
          else
            echo "âš ï¸  Skip file not found: $SKIPFILE"
          fi

      - name: Commit skipped_players.txt
        run: |
          set -e
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          SKIPFILE="MinifaceServer/content/miniface-server/skipped_players.txt"
          if [ -f "$SKIPFILE" ]; then
            git add "$SKIPFILE"
            if ! git diff --cached --quiet; then
              git commit -m "chore: update skipped_players.txt from featured update run"
              git push origin HEAD:${GITHUB_REF##*/}
              echo "Pushed updated skip list"
            else
              echo "No changes in skip list"
            fi
          else
            echo "Skip file not found: $SKIPFILE"
          fi

      - name: Prepare background version folder structure
        run: |
          echo "Copying static files to background version..."
          
          # Copy modules directory
          mkdir -p MinifaceServer-Background/modules
          cp -r MinifaceServer/modules/* MinifaceServer-Background/modules/
          
          # Copy credits.txt if exists
          if [ -f "MinifaceServer/content/miniface-server/credits.txt" ]; then
            cp MinifaceServer/content/miniface-server/credits.txt MinifaceServer-Background/content/miniface-server/
          fi
          
          echo "âœ… Background version folder structure prepared"

      - name: Create optimized featured players archives
        run: |
          echo "Creating featured players archives for both versions..."

          # Create standard (no-background) archive
          echo "Creating standard version archive..."
          rar a -r -m5 -ep1 "MiniFaceServer-$(date +'%m-%d-%Y')-Update.rar" MinifaceServer \
            -x*.tmp -x*.log -x__pycache__ -x*.pyc
          standard_size=$(du -h "MiniFaceServer-$(date +'%m-%d-%Y')-Update.rar" | cut -f1)
          echo "âœ… Standard update archive created: $standard_size"

          # Create background version archive
          echo "Creating background version archive..."
          rar a -r -m5 -ep1 "MiniFaceServer-Background-$(date +'%m-%d-%Y')-Update.rar" MinifaceServer-Background \
            -x*.tmp -x*.log -x__pycache__ -x*.pyc
          background_size=$(du -h "MiniFaceServer-Background-$(date +'%m-%d-%Y')-Update.rar" | cut -f1)
          echo "âœ… Background update archive created: $background_size"

          echo ""
          echo "ðŸ“¦ Update Archive Summary:"
          echo "  - Standard (no-background): $standard_size"
          echo "  - Background (composite): $background_size"

          # Store for release notes
          echo "ARCHIVE_STANDARD_SIZE=$standard_size" >> $GITHUB_ENV
          echo "ARCHIVE_BACKGROUND_SIZE=$background_size" >> $GITHUB_ENV

      - name: Set release variables
        run: |
          echo "RELEASE_NAME=MiniFaceServer-$(date +'%m-%d-%Y')" >> $GITHUB_ENV
          echo "NEXT_VER_CODE=$(date +'%m%d%Y')" >> $GITHUB_ENV
          echo "RELEASE_DATE=$(date +'%B %d, %Y')" >> $GITHUB_ENV
          echo "UPDATE_ARCHIVE=MiniFaceServer-$(date +'%m-%d-%Y')-Update.rar" >> $GITHUB_ENV
          echo "UPDATE_ARCHIVE_BG=MiniFaceServer-Background-$(date +'%m-%d-%Y')-Update.rar" >> $GITHUB_ENV

          # Set trigger type for release notes
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "TRIGGER_TYPE=Manual" >> $GITHUB_ENV
            echo "TRIGGER_DETAILS=Manually triggered featured players update" >> $GITHUB_ENV
          else
            echo "TRIGGER_TYPE=Scheduled" >> $GITHUB_ENV
            echo "TRIGGER_DETAILS=Automatically triggered featured players update" >> $GITHUB_ENV
          fi

      - name: Check if release exists and add update or create new release
        run: |
          # Check if release with this tag already exists
          if gh release view ${{ env.NEXT_VER_CODE }} >/dev/null 2>&1; then
            echo "Release ${{ env.NEXT_VER_CODE }} exists, uploading both featured players updates..."
            gh release upload ${{ env.NEXT_VER_CODE }} "${{ env.UPDATE_ARCHIVE }}" --clobber
            gh release upload ${{ env.NEXT_VER_CODE }} "${{ env.UPDATE_ARCHIVE_BG }}" --clobber
            echo "âœ… Both featured players updates added to existing release"
          else
            echo "Release ${{ env.NEXT_VER_CODE }} does not exist, creating new release..."
            gh release create ${{ env.NEXT_VER_CODE }} \
              "${{ env.UPDATE_ARCHIVE }}" \
              "${{ env.UPDATE_ARCHIVE_BG }}" \
              --title "${{ env.RELEASE_NAME }}" \
              --notes "# eFootball MinifacesServer - ${{ env.RELEASE_DATE }}
            
            **Release Type:** ${{ env.TRIGGER_TYPE }} (Featured Players Update)
            **Generated:** ${{ env.TRIGGER_DETAILS }}
            
            This release contains **two versions** of the featured players update:
            
            ## ðŸ“¦ Downloads
            
            ### MiniFaceServer-$(date +'%m-%d-%Y')-Update.rar (${{ env.ARCHIVE_STANDARD_SIZE }})
            **Standard Version (No Background)**
            - Player faces without event backgrounds
            - Original/simpler implementation
            - File size: Nearly identical to background version (same resolution, DXT5 compression)
            
            ### MiniFaceServer-Background-$(date +'%m-%d-%Y')-Update.rar (${{ env.ARCHIVE_BACKGROUND_SIZE }})
            **Background Version (Composite)**
            - Enhanced visuals with event backgrounds composited
            - Background + foreground merged images
            - File size: Nearly identical to standard version (same resolution, DXT5 compression)
            
            **Both versions have the same resolution and compression. Choose based on visual preference!**
            
            ## Installation
            1. Download your preferred version (matching your base installation)
            2. Extract the archive
            3. Copy "content" and "modules" folder to your sider folder
            4. Add the following line in your sider.ini:
            \`\`\`
            lua.module = \"MiniFaceServer.lua\"
            \`\`\`
            
            ## Technical Details
            - Generated using optimized multithreaded downloader with Python 3.14t free-threading
            - Source: PESMaster featured players
            - Release Date: ${{ env.RELEASE_DATE }}
            - Total Featured Players: ${{ env.TOTAL_FEATURED_PLAYERS }}
            - Both versions contain identical player coverage
            
            For more info: https://evoweb.uk/threads/efootball-featured-players-miniface-server-automated-aio.91794/
            ---
            *This release was generated by GitHub Actions using the optimized featured players script*"
            echo "âœ… New release created with both featured players updates"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
